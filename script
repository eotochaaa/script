local function aplicarVisual(jogador)
    if jogador == LocalPlayer then return end

    local function criarOuAtualizarHighlight()
        local highlight = highlights[jogador]
        if not highlight or not highlight:IsDescendantOf(game) then
            highlight = Instance.new("Highlight")
            highlight.Name = "ESP_Highlight"
            highlight.FillColor = Color3.fromRGB(255, 0, 0)
            highlight.FillTransparency = 0.5
            highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
            highlight.OutlineTransparency = 0
            highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
            highlight.Parent = game.CoreGui
            highlights[jogador] = highlight
        end
        if jogador.Character then
            highlight.Adornee = jogador.Character
        end
    end

    local function criarOuAtualizarBillboard()
        local billboard = billboards[jogador]
        if not billboard or not billboard:IsDescendantOf(game) then
            billboard = Instance.new("BillboardGui")
            billboard.Name = "ESP_Name"
            billboard.Size = UDim2.new(0, 200, 0, 30)
            billboard.StudsOffset = Vector3.new(0, 3, 0)
            billboard.AlwaysOnTop = true
            billboard.Parent = game.CoreGui

            local nameLabel = Instance.new("TextLabel", billboard)
            nameLabel.Size = UDim2.new(1, 0, 1, 0)
            nameLabel.BackgroundTransparency = 1
            nameLabel.Text = jogador.Name
            nameLabel.TextColor3 = Color3.fromRGB(0, 255, 255)
            nameLabel.TextStrokeTransparency = 0.5
            nameLabel.TextScaled = true

            billboards[jogador] = billboard
        end

        if jogador.Character then
            local head = jogador.Character:FindFirstChild("Head") or jogador.Character:FindFirstChildWhichIsA("BasePart")
            billboard.Adornee = head
        end
    end

    local function forcarPartesVisiveis()
        if not jogador.Character then return end
        for _, part in ipairs(jogador.Character:GetDescendants()) do
            if part:IsA("BasePart") then
                part.LocalTransparencyModifier = 0
            end
        end
    end

    criarOuAtualizarHighlight()
    criarOuAtualizarBillboard()
    forcarPartesVisiveis()

    jogador.CharacterAdded:Connect(function()
        wait(1)
        removerVisual(jogador)
        if chamsAtivo then
            aplicarVisual(jogador)
        end
    end)
end
