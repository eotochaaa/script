local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer

-- GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "PainelTesteESP"
screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
screenGui.ResetOnSpawn = false

-- Main Frame
local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 200, 0, 100)
frame.Position = UDim2.new(0, 20, 0, 100)
frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
frame.BorderSizePixel = 0
frame.Parent = screenGui

-- Título
local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, 0, 0, 40)
title.Position = UDim2.new(0, 0, 0, 0)
title.Text = "Painel de Teste Anti-Cheat"
title.TextColor3 = Color3.new(1,1,1)
title.BackgroundTransparency = 1
title.Font = Enum.Font.SourceSansBold
title.TextScaled = true
title.Parent = frame

-- Botão ESP
local espBtn = Instance.new("TextButton")
espBtn.Size = UDim2.new(0.8, 0, 0, 40)
espBtn.Position = UDim2.new(0.1, 0, 0, 50)
espBtn.Text = "Ativar ESP"
espBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
espBtn.TextColor3 = Color3.new(1, 1, 1)
espBtn.Font = Enum.Font.SourceSans
espBtn.TextScaled = true
espBtn.BorderSizePixel = 0
espBtn.Parent = frame

-- Variáveis para arrastar
local dragging = false
local dragInput
local dragStart
local startPos

local function update(input)
    local delta = input.Position - dragStart
    frame.Position = UDim2.new(
        startPos.X.Scale,
        startPos.X.Offset + delta.X,
        startPos.Y.Scale,
        startPos.Y.Offset + delta.Y
    )
end

-- Eventos para drag
frame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = frame.Position

        input.Changed:Connect(function()
            if input.UserInputState == Enum.UserInputState.End then
                dragging = false
            end
        end)
    end
end)

frame.InputChanged:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseMovement then
        dragInput = input
    end
end)

UserInputService.InputChanged:Connect(function(input)
    if input == dragInput and dragging then
        update(input)
    end
end)

-- ESP logic
local espAtivo = false
local torsoESP = {}
local nameTags = {}

local function removerESP(jogador)
    if torsoESP[jogador] then
        torsoESP[jogador]:Destroy()
        torsoESP[jogador] = nil
    end
    if nameTags[jogador] then
        nameTags[jogador]:Destroy()
        nameTags[jogador] = nil
    end
end

local function aplicarESP(jogador)
    if jogador == LocalPlayer then return end
    if jogador.Character then
        -- Caixa no torso
        if not torsoESP[jogador] then
            local torso = jogador.Character:FindFirstChild("UpperTorso") or jogador.Character:FindFirstChild("Torso") or jogador.Character:FindFirstChild("HumanoidRootPart")
            if torso then
                local box = Instance.new("BoxHandleAdornment")
                box.Name = "ESP_TorsoBox"
                box.Adornee = torso
                box.AlwaysOnTop = true
                box.ZIndex = 5
                box.Size = torso.Size + Vector3.new(0.1, 0.1, 0.1)
                box.Transparency = 0.2
                box.Color3 = Color3.fromRGB(255, 0, 0)
                box.Parent = screenGui
                torsoESP[jogador] = box
            end
        end

        -- Nome acima da cabeça
        if not nameTags[jogador] then
            local head = jogador.Character:FindFirstChild("Head") or jogador.Character:FindFirstChild("UpperTorso") or jogador.Character:FindFirstChild("HumanoidRootPart")
            if head then
                local billboard = Instance.new("BillboardGui")
                billboard.Name = "ESP_NameTag"
                billboard.Size = UDim2.new(0, 200, 0, 25)
                billboard.StudsOffset = Vector3.new(0, 2.5, 0)
                billboard.AlwaysOnTop = true
                billboard.Adornee = head
                billboard.Parent = screenGui

                local label = Instance.new("TextLabel")
                label.Size = UDim2.new(1, 0, 1, 0)
                label.BackgroundTransparency = 1
                label.TextColor3 = Color3.new(1, 0, 0)
                label.TextStrokeTransparency = 0.5
                label.TextScaled = true
                label.Font = Enum.Font.SourceSansBold
                label.Text = jogador.Name
                label.Parent = billboard

                nameTags[jogador] = billboard
            end
        end
    end

    jogador.CharacterAdded:Connect(function()
        wait(1)
        removerESP(jogador)
        if espAtivo then
            aplicarESP(jogador)
        end
    end)
end

local function atualizarESP()
    for _, jogador in pairs(Players:GetPlayers()) do
        if jogador ~= LocalPlayer then
            if espAtivo then
                aplicarESP(jogador)
            else
                removerESP(jogador)
            end
        end
    end
end

-- Jogador novo entra
Players.PlayerAdded:Connect(function(jogador)
    jogador.CharacterAdded:Connect(function()
        wait(1)
        if espAtivo then
            aplicarESP(jogador)
        end
    end)
end)

-- Botão de ativar ESP
espBtn.MouseButton1Click:Connect(function()
    espAtivo = not espAtivo
    espBtn.Text = espAtivo and "Desativar ESP" or "Ativar ESP"
    atualizarESP()
end)

-- Inicia para jogadores existentes
for _, jogador in pairs(Players:GetPlayers()) do
    if jogador ~= LocalPlayer and jogador.Character then
        aplicarESP(jogador)
    end
end
